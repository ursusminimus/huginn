<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Huginn Timekeeper</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        :root {
            /* Palette from color scheme.md */
            --bg-dark: #2C3639;       /* Pale Gunmetal */
            --bg-panel: #3F4E4F;      /* Pale Dark Slate Grey */
            --accent-brown: #A27B5C;  /* Pale French Beige */
            --text-light: #DCD7C9;    /* Vibrant Timberwolf */
            --text-muted: #8b7e74;    /* Pale Almond Frost */
            
            /* Signal Colors */
            --signal-green: #228b22;
            --signal-yellow: #daa520;
            --signal-red: #8b0000;
            
            /* Inputs */
            --input-bg: #DBD7D2;
            --input-text: #1f1f1f;
        }

        body {
            font-family: "Georgia", serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            margin: 0;
            padding: 15px;
            font-size: 0.95em;
            overflow-y: scroll;
        }

        /* Layout Grid */
        .container {
            display: grid;
            grid-template-columns: 350px 1fr;
            grid-template-rows: auto 1fr;
            gap: 15px;
            height: calc(100vh - 30px);
        }

        /* Header / Active Timer */
        header {
            grid-column: 1 / -1;
            background-color: var(--bg-panel);
            padding: 15px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #5a5a5a;
        }

        .active-timer-display {
            flex-grow: 1;
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            color: var(--accent-brown);
        }

        .active-project-name {
            font-size: 0.7em;
            color: var(--text-muted);
            display: block;
        }

        /* Project Tree Panel */
        .panel-left {
            grid-column: 1 / 2;
            background-color: var(--bg-panel);
            border-radius: 5px;
            border: 1px solid #5a5a5a;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 10px;
            background-color: rgba(0,0,0,0.2);
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tree-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }

        /* Main Content / Tabs */
        .panel-right {
            grid-column: 2 / 3;
            background-color: var(--bg-panel);
            border-radius: 5px;
            border: 1px solid #5a5a5a;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background-color: rgba(0,0,0,0.2);
        }
        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            border-right: 1px solid #5a5a5a;
        }
        .tab-btn:hover { color: var(--text-light); background-color: rgba(255,255,255,0.05); }
        .tab-btn.active {
            color: var(--bg-dark);
            background-color: var(--accent-brown);
        }

        .tab-content {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: none;
        }
        .tab-content.active { display: block; }

        /* Project Items in Tree */
        .project-item {
            display: flex;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .project-item:hover { background-color: rgba(255,255,255,0.05); }
        
        .indent-guide {
            border-left: 1px dashed var(--text-muted);
            height: 100%;
            display: inline-block;
            width: 1px;
            margin-right: 15px;
            opacity: 0.3;
        }

        .project-name {
            flex-grow: 1;
            cursor: pointer;
            user-select: none;
        }
        .project-name:hover { color: var(--accent-brown); }

        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 1.1em;
            padding: 0 5px;
            transition: color 0.2s;
        }
        .btn-icon:hover { color: var(--text-light); }
        
        .btn-start { color: var(--text-muted); }
        .btn-start:hover { color: var(--signal-green); }
        .btn-stop { color: var(--signal-red); font-weight: bold; font-size: 1.2em; }
        
        /* Log Table */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        th { text-align: left; border-bottom: 2px solid var(--accent-brown); padding: 5px; color: var(--accent-brown); }
        td { border-bottom: 1px solid #5a5a5a; padding: 5px; }
        tr:hover td { background-color: rgba(255,255,255,0.05); cursor: pointer; }
        .edited-tag {
            font-size: 0.7em;
            background-color: var(--signal-yellow);
            color: #000;
            padding: 1px 4px;
            border-radius: 3px;
            margin-left: 5px;
        }

        /* Buttons & Forms */
        button.primary {
            background-color: var(--accent-brown);
            color: var(--bg-dark);
            border: none;
            padding: 8px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
        }
        button.primary:hover { filter: brightness(1.1); }
        
        button.danger {
            background-color: var(--signal-red);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 3px;
            cursor: pointer;
        }

        input[type="text"], input[type="datetime-local"], select {
            background-color: var(--input-bg);
            border: 1px solid #5a5a5a;
            padding: 6px;
            border-radius: 3px;
            color: var(--input-text);
            font-family: inherit;
        }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal {
            background-color: var(--bg-panel);
            padding: 20px;
            border-radius: 5px;
            border: 1px solid var(--accent-brown);
            width: 400px;
            max-width: 90%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .modal h2 { margin-top: 0; color: var(--accent-brown); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        .form-group input, .form-group select { width: 100%; box-sizing: border-box; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #5a5a5a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-brown); }

    </style>
</head>
<body>

    <header>
        <div style="font-weight: bold; font-size: 1.2em;">Huginn Timekeeper</div>
        <div class="active-timer-display" id="timerDisplay">
            <span class="active-project-name" id="timerProjectName">No active project</span>
            <span id="timerClock">00:00:00</span>
        </div>
        <div>
            <button class="primary" id="stopBtn" style="display: none; background-color: var(--signal-red); color: white;">STOP</button>
            <button class="primary" onclick="exportData()" title="Download Muninn Timekeeper.json">Export</button>
            <button class="primary" onclick="document.getElementById('importFile').click()" title="Load JSON">Import</button>
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(this)">
        </div>
    </header>

    <div class="container">
        <div class="panel-left">
            <div class="panel-header">
                <span>Projects</span>
                <button class="btn-icon" onclick="openProjectModal()" title="New Root Project (N)">➕</button>
            </div>
            <div class="tree-container" id="projectTree">
                </div>
        </div>

        <div class="panel-right">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('log')">Log</button>
                <button class="tab-btn" onclick="switchTab('viz')">Viz</button>
                <button class="tab-btn" onclick="switchTab('stats')">Stats</button>
            </div>

            <div id="tab-log" class="tab-content active">
                <h3>Activity History</h3>
                <table id="logTable">
                    <thead>
                        <tr>
                            <th>Project</th>
                            <th>Start</th>
                            <th>End</th>
                            <th>Duration</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div id="tab-viz" class="tab-content">
                <h3>Timeline (Last 7 Days)</h3>
                <div id="vizGantt" style="width: 100%; height: 300px;"></div>
                <h3>Session Length Distribution</h3>
                <div id="vizHist" style="width: 100%; height: 300px;"></div>
            </div>

            <div id="tab-stats" class="tab-content">
                <h3>Total Time per Project</h3>
                <table id="statsTable">
                    <thead><tr><th>Project</th><th>Total Time</th><th>Sessions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="projectModal" class="modal-overlay">
        <div class="modal">
            <h2 id="projModalTitle">Add Project</h2>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="projName" autofocus>
            </div>
            <div class="form-group">
                <label>Parent Project</label>
                <select id="projParent">
                    <option value="">(Root)</option>
                </select>
            </div>
            <div class="modal-actions">
                <button onclick="closeModals()">Cancel</button>
                <button class="primary" onclick="saveProject()">Save</button>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal-overlay">
        <div class="modal">
            <h2>Edit Activity</h2>
            <input type="hidden" id="editId">
            <div class="form-group">
                <label>Project</label>
                <select id="editProject"></select>
            </div>
            <div class="form-group">
                <label>Start Time</label>
                <input type="datetime-local" id="editStart">
            </div>
            <div class="form-group">
                <label>End Time</label>
                <input type="datetime-local" id="editEnd">
            </div>
            <div class="modal-actions">
                <button class="danger" onclick="deleteActivity()">Delete</button>
                <button onclick="closeModals()">Cancel</button>
                <button class="primary" onclick="saveActivityEdit()">Save</button>
            </div>
        </div>
    </div>

<script>
    // --- Data Structure ---
    // projects: { id: number, name: string, parentId: number|null }
    // activities: { id: number, projectId: number, start: ISOString, end: ISOString|null, edited: boolean }
    
    let data = {
        projects: [],
        activities: []
    };

    const STORAGE_KEY = 'muninnTimekeeperData';
    let timerInterval = null;
    let editingActivityId = null;

    // --- Initialization ---
    function init() {
        loadData();
        if(data.projects.length === 0) {
            // Default example project
            data.projects.push({ id: 1, name: 'General', parentId: null });
        }
        render();
        // Global hotkeys
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            if (e.key === 'Escape') closeModals();
            if (e.code === 'Space') { 
                e.preventDefault(); // prevent scroll
                stopTimer(); 
            }
            if (e.key.toLowerCase() === 'n') openProjectModal();
        });
        
        // Start UI tick
        setInterval(updateTimerDisplay, 1000);
        updateTimerDisplay();
    }

    function loadData() {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
            try { data = JSON.parse(stored); } catch(e) { console.error(e); }
        }
    }

    function saveData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        render(); // Re-render helps update views immediately
    }

    // --- Core Logic ---

    function startTimer(projectId) {
        // Stop any running timer first
        stopTimer();
        
        const newActivity = {
            id: Date.now(),
            projectId: projectId,
            start: new Date().toISOString(),
            end: null,
            edited: false
        };
        data.activities.push(newActivity);
        saveData();
    }

    function stopTimer() {
        const active = data.activities.find(a => a.end === null);
        if (active) {
            active.end = new Date().toISOString();
            saveData();
        }
    }

    function addProject(name, parentId) {
        data.projects.push({
            id: Date.now(),
            name: name,
            parentId: parentId ? Number(parentId) : null
        });
        saveData();
    }

    // --- Rendering ---

    function render() {
        renderTree();
        renderLog();
        renderStats();
        // Charts are rendered when tab is switched to save resources
    }

    function renderTree() {
        const container = document.getElementById('projectTree');
        container.innerHTML = '';

        // Build hierarchy
        const map = {};
        data.projects.forEach(p => map[p.id] = { ...p, children: [] });
        const roots = [];
        data.projects.forEach(p => {
            if (p.parentId && map[p.parentId]) {
                map[p.parentId].children.push(map[p.id]);
            } else {
                roots.push(map[p.id]);
            }
        });

        const activeId = data.activities.find(a => a.end === null)?.projectId;

        function buildNode(node, depth) {
            const div = document.createElement('div');
            div.className = 'project-item';
            div.style.paddingLeft = (depth * 15) + 'px';
            
            // Name
            const nameSpan = document.createElement('span');
            nameSpan.className = 'project-name';
            nameSpan.textContent = node.name;
            if (node.id === activeId) nameSpan.style.color = 'var(--signal-green)';
            div.appendChild(nameSpan);

            // Add Subproject Button
            const addBtn = document.createElement('button');
            addBtn.className = 'btn-icon';
            addBtn.innerHTML = '+';
            addBtn.title = "Add Sub-project";
            addBtn.onclick = (e) => { e.stopPropagation(); openProjectModal(node.id); };
            div.appendChild(addBtn);

            // Play Button (only if not active)
            if (node.id !== activeId) {
                const playBtn = document.createElement('button');
                playBtn.className = 'btn-icon btn-start';
                playBtn.innerHTML = '▶';
                playBtn.title = "Start Timer";
                playBtn.onclick = (e) => { e.stopPropagation(); startTimer(node.id); };
                div.appendChild(playBtn);
            } else {
                // Running indicator
                const runningIcon = document.createElement('span');
                runningIcon.innerHTML = '⏳';
                runningIcon.style.marginRight = '5px';
                div.appendChild(runningIcon);
            }

            container.appendChild(div);
            
            if (node.children) {
                node.children.forEach(child => buildNode(child, depth + 1));
            }
        }

        roots.forEach(r => buildNode(r, 0));
    }

    function renderLog() {
        const tbody = document.querySelector('#logTable tbody');
        tbody.innerHTML = '';
        
        // Sort descending
        const sorted = [...data.activities].sort((a,b) => new Date(b.start) - new Date(a.start));
        
        // Helper to find path name
        const getProjName = (pid) => {
            let p = data.projects.find(x => x.id === pid);
            return p ? p.name : 'Unknown';
        };

        sorted.forEach(act => {
            if (!act.end) return; // Don't show currently running in history yet
            
            const tr = document.createElement('tr');
            tr.onclick = () => openEditModal(act.id);

            const start = new Date(act.start);
            const end = new Date(act.end);
            const durMs = end - start;
            
            let projCell = `<td>${getProjName(act.projectId)}`;
            if (act.edited) projCell += `<span class="edited-tag">Edited</span>`;
            projCell += `</td>`;

            tr.innerHTML = `
                ${projCell}
                <td>${start.toLocaleString()}</td>
                <td>${end.toLocaleTimeString()}</td>
                <td>${formatDuration(durMs)}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderStats() {
        const tbody = document.querySelector('#statsTable tbody');
        tbody.innerHTML = '';

        const totals = {}; // projectId -> ms
        const counts = {}; // projectId -> count

        data.activities.forEach(act => {
            if(!act.end) return;
            const ms = new Date(act.end) - new Date(act.start);
            totals[act.projectId] = (totals[act.projectId] || 0) + ms;
            counts[act.projectId] = (counts[act.projectId] || 0) + 1;
        });

        // Convert to array and sort by time desc
        const statsArr = Object.keys(totals).map(pid => ({
            pid: Number(pid),
            ms: totals[pid],
            count: counts[pid]
        })).sort((a,b) => b.ms - a.ms);

        statsArr.forEach(item => {
            const p = data.projects.find(x => x.id === item.pid);
            if (!p) return;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${p.name}</td>
                <td>${formatDuration(item.ms)}</td>
                <td>${item.count}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updateTimerDisplay() {
        const active = data.activities.find(a => a.end === null);
        const displayTime = document.getElementById('timerClock');
        const displayName = document.getElementById('timerProjectName');
        const stopBtn = document.getElementById('stopBtn');

        if (active) {
            const start = new Date(active.start);
            const now = new Date();
            const diff = now - start;
            displayTime.textContent = formatDuration(diff);
            displayTime.style.color = "var(--text-light)";
            
            const p = data.projects.find(x => x.id === active.projectId);
            displayName.textContent = p ? p.name : 'Unknown Project';
            
            stopBtn.style.display = 'inline-block';
            stopBtn.onclick = stopTimer;
        } else {
            displayTime.textContent = "00:00:00";
            displayTime.style.color = "var(--text-muted)";
            displayName.textContent = "No active project";
            stopBtn.style.display = 'none';
        }
    }

    // --- Visualization (Plotly) ---
    function renderCharts() {
        const finished = data.activities.filter(a => a.end !== null);
        if (finished.length === 0) return;

        // 1. Gantt / Timeline (Last 7 Days)
        const traceGantt = {
            x: [], y: [], base: [], type: 'bar', orientation: 'h',
            marker: { color: '#A27B5C' },
            hoverinfo: 'x+y'
        };
        // Simple stacked bar approach for timeline is tricky in Plotly JS without 'gantt' specialized type (which is deprecated or paid in some versions), 
        // using scatter or generic bar. Let's use simple Scatter lines for simplicity and robustness.
        
        // Alternative: Timeline logic. 
        // X axis: Time. Y axis: Project Name.
        const traceTimeline = {
            x: [], y: [], type: 'scatter', mode: 'lines', 
            line: { width: 10, color: '#A27B5C' }
        };

        // Prepare data for "Timeline" - actually lets use Bar chart with 'base' property for duration
        const projectsMap = {};
        data.projects.forEach(p => projectsMap[p.id] = p.name);

        const ganttData = [];
        const cutOff = new Date();
        cutOff.setDate(cutOff.getDate() - 7);

        finished.forEach(act => {
            const s = new Date(act.start);
            const e = new Date(act.end);
            if (s < cutOff) return;
            
            // Plotly 'bar' hack for Gantt:
            // Needs multiple traces or careful data shaping.
            // Simplest robust method: One trace per activity? No, too heavy.
            // Let's use specific Plotly timeline format if available, otherwise Scatter.
            // We will use "Scatter" mode 'lines' with very thick lines.
            
            // Adding null to break lines
            ganttData.push({
                x: [act.start, act.end, null],
                y: [projectsMap[act.projectId], projectsMap[act.projectId], null],
                mode: 'lines',
                line: { color: '#A27B5C', width: 15 },
                type: 'scatter',
                showlegend: false,
                hoverinfo: 'x+y'
            });
        });

        const layoutGantt = {
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: '#DCD7C9' },
            margin: { l: 100, r: 20, t: 20, b: 40 },
            xaxis: { type: 'date', gridcolor: '#5a5a5a' },
            yaxis: { gridcolor: '#5a5a5a', type: 'category' }
        };
        
        // Flatten data array for plotly
        // Actually, creating one trace per project is cleaner
        const traces = [];
        const pIds = [...new Set(finished.map(a => a.projectId))];
        
        pIds.forEach(pid => {
            const acts = finished.filter(a => a.projectId === pid && new Date(a.start) > cutOff);
            if (acts.length === 0) return;
            
            const x = [];
            const y = [];
            
            acts.forEach(a => {
                x.push(a.start);
                x.push(a.end);
                x.push(null); // break line
                y.push(projectsMap[pid]);
                y.push(projectsMap[pid]);
                y.push(null);
            });
            
            traces.push({
                x: x, y: y, mode: 'lines', 
                line: { width: 15, color: '#A27B5C' },
                name: projectsMap[pid],
                showlegend: false
            });
        });

        Plotly.newPlot('vizGantt', traces, layoutGantt);

        // 2. Histogram (Session Lengths in Minutes)
        const durations = finished.map(a => (new Date(a.end) - new Date(a.start)) / 60000); // mins
        const traceHist = {
            x: durations,
            type: 'histogram',
            marker: { color: '#228b22' }
        };
        const layoutHist = {
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: '#DCD7C9' },
            xaxis: { title: 'Minutes', gridcolor: '#5a5a5a' },
            yaxis: { title: 'Count', gridcolor: '#5a5a5a' },
            margin: { l: 40, r: 20, t: 20, b: 40 }
        };
        Plotly.newPlot('vizHist', [traceHist], layoutHist);
    }

    // --- Helpers ---
    function formatDuration(ms) {
        const sec = Math.floor(ms / 1000);
        const h = Math.floor(sec / 3600);
        const m = Math.floor((sec % 3600) / 60);
        const s = sec % 60;
        return `${pad(h)}:${pad(m)}:${pad(s)}`;
    }
    function pad(n) { return n < 10 ? '0'+n : n; }

    // --- Tabs ---
    function switchTab(name) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-'+name).classList.add('active');
        document.querySelector(`button[onclick="switchTab('${name}')"]`).classList.add('active');
        
        if (name === 'viz') {
            setTimeout(renderCharts, 100); // Allow DOM to sizing
        }
    }

    // --- Modals ---
    function openProjectModal(parentId = null) {
        document.getElementById('projectModal').style.display = 'flex';
        document.getElementById('projName').value = '';
        const sel = document.getElementById('projParent');
        sel.innerHTML = '<option value="">(Root)</option>';
        data.projects.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.name;
            if(p.id === parentId) opt.selected = true;
            sel.appendChild(opt);
        });
        document.getElementById('projName').focus();
    }

    function saveProject() {
        const name = document.getElementById('projName').value;
        const parent = document.getElementById('projParent').value;
        if(name) {
            addProject(name, parent);
            closeModals();
        }
    }

    function openEditModal(actId) {
        editingActivityId = actId;
        const act = data.activities.find(a => a.id === actId);
        if(!act) return;

        document.getElementById('editModal').style.display = 'flex';
        
        // Populate Projects
        const sel = document.getElementById('editProject');
        sel.innerHTML = '';
        data.projects.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.name;
            if(p.id === act.projectId) opt.selected = true;
            sel.appendChild(opt);
        });

        // Populate Times (Local ISO format for input type=datetime-local)
        // Need to handle timezone offset for input value
        const toLocalISO = (isoStr) => {
            if(!isoStr) return '';
            const d = new Date(isoStr);
            d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
            return d.toISOString().slice(0, 16);
        };
        
        document.getElementById('editStart').value = toLocalISO(act.start);
        document.getElementById('editEnd').value = toLocalISO(act.end);
    }

    function saveActivityEdit() {
        const act = data.activities.find(a => a.id === editingActivityId);
        if(!act) return;

        const pId = Number(document.getElementById('editProject').value);
        const sVal = document.getElementById('editStart').value;
        const eVal = document.getElementById('editEnd').value;

        if (sVal) act.start = new Date(sVal).toISOString();
        if (eVal) act.end = new Date(eVal).toISOString();
        act.projectId = pId;
        act.edited = true;

        saveData();
        closeModals();
    }

    function deleteActivity() {
        if(confirm("Are you sure you want to delete this log entry?")) {
            data.activities = data.activities.filter(a => a.id !== editingActivityId);
            saveData();
            closeModals();
        }
    }

    function closeModals() {
        document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none');
        editingActivityId = null;
    }

    // --- Export / Import ---
    function exportData() {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'Muninn Timekeeper.json';
        a.click();
    }

    function importData(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                if (json.projects && json.activities) {
                    data = json;
                    saveData();
                    alert("Import successful!");
                } else {
                    alert("Invalid file format.");
                }
            } catch(err) {
                console.error(err);
                alert("Error parsing JSON.");
            }
        };
        reader.readAsText(file);
    }

    // Start
    init();

</script>
</body>
</html>